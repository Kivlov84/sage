- pipeline: "Build and Deploy Sage WordPress Theme"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Install Composer Packages/Sage Dependencies"
    type: "BUILD"
    working_directory: "/buddy/docker-wordpress-theme"
    docker_image_name: "library/php"
    docker_image_tag: "7.2-stretch"
    execute_commands:
    - "# navigate to theme directory"
    - "cd sage"
    - ""
    - "# install php packages"
    - "composer validate"
    - "composer install"
    setup_commands:
    - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "# php ext gd"
    - "apt-get install -y libfreetype6-dev"
    - "apt-get install -y libjpeg62-turbo-dev"
    - "apt-get install -y libpng-dev"
    - "docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/"
    - "docker-php-ext-install gd"
    - "# php ext zip"
    - "apt-get install -y zip"
    - "apt-get install -y unzip"
    - "apt-get install -y zlib1g-dev"
    - "docker-php-ext-install zip"
    - "# php ext pdo_mysql"
    - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
    - "docker-php-ext-install pdo_mysql"
    volume_mappings:
    - "/:/buddy/docker-wordpress-theme"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "Install Node.js Dependencies and Build Theme"
    type: "BUILD"
    working_directory: "/buddy/docker-wordpress-theme"
    docker_image_name: "library/node"
    docker_image_tag: "10"
    execute_commands:
    - "# navigate to theme directory"
    - "cd sage"
    - ""
    - "# install packages"
    - "yarn install"
    - ""
    - "# Create production build"
    - "yarn build:production"
    setup_commands:
    - "npm install -g gulp grunt-cli"
    volume_mappings:
    - "/:/buddy/docker-wordpress-theme"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "Upload files to wordpress-buddy"
    type: "DIGITAL_OCEAN"
    input_type: "BUILD_ARTIFACTS"
    local_path: "sage/"
    remote_path: "/var/www/html/wp-content/themes/sage"
    login: "root"
    host: "67.205.184.17"
    host_name: "wordpress-buddy"
    port: "22"
    env_key: "secure!TKk+snJU+ja3SbVGqSpNww==.KFZwmhwffE9GZngJjxLVzQ=="
    authentication_mode: "ENV_KEY"
    deployment_excludes:
    - ".cache-loader/"
    - "node_modules/"
    integration_hash: "5e5663e5422f5a4944dad87d"
  - action: "WP CLI - Activate Sage Theme"
    type: "SSH_COMMAND"
    working_directory: "/var/www/html/wp-content/themes"
    login: "root"
    host: "wordpress.wallesdevelopers.com"
    port: "22"
    env_key: "secure!TKk+snJU+ja3SbVGqSpNww==.KFZwmhwffE9GZngJjxLVzQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "# Activate Sage Theme"
    - "sudo -u www-data -- wp theme activate sage/resources"
    trigger_condition: "ALWAYS"
    run_as_script: true
    shell: "BASH"

